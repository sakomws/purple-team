name: Deploy Production
run-name: Production Deploy - ${{ github.actor }}

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: production
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    outputs:
      api_url: ${{ steps.backend-outputs.outputs.api_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.PIPELINE_EXECUTION_ROLE }}

      - name: Replace Variables in samconfig
        working-directory: backend
        env:
          STACK_NAME: purple-team-backend-prod
          ENV_HASH: prod
          ENV_NAME: production
        run: |
          envsubst < samconfig.yaml.template > samconfig.yaml
          echo "Generated samconfig.yaml:"
          cat samconfig.yaml

      - name: Deploy backend stack
        working-directory: backend
        run: |
          npm install -g esbuild
          npm ci

          sam build --template-file template.yaml

          sam deploy \
            --config-file samconfig.yaml \
            --config-env dev \
            --s3-bucket "${{ secrets.ARTIFACTS_BUCKET_NAME }}" \
            --role-arn "${{ secrets.CLOUDFORMATION_EXECUTION_ROLE }}" \
            --no-fail-on-empty-changeset

      - name: Retrieve backend outputs
        id: backend-outputs
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name purple-team-backend-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)

          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Backend Deployed
          * API URL: \`$API_URL\`
          EOF

  deploy-frontend-infrastructure:
    name: Deploy Frontend Infrastructure
    needs: [deploy-backend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.PIPELINE_EXECUTION_ROLE }}

      - name: Generate samconfig
        working-directory: frontend
        env:
          STACK_NAME: purple-team-frontend-prod
        run: |
          envsubst < samconfig.yaml.template > samconfig.yaml
          echo "Generated samconfig.yaml:"
          cat samconfig.yaml

      - name: Deploy frontend stack
        working-directory: frontend
        run: |
          sam build --template-file template.yaml

          sam deploy \
            --config-file samconfig.yaml \
            --config-env dev \
            --s3-bucket "${{ secrets.ARTIFACTS_BUCKET_NAME }}" \
            --role-arn "${{ secrets.CLOUDFORMATION_EXECUTION_ROLE }}" \
            --no-fail-on-empty-changeset

  build-and-deploy-frontend:
    name: Build and Deploy Frontend
    needs: [deploy-backend, deploy-frontend-infrastructure]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.PIPELINE_EXECUTION_ROLE }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build React application
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ needs.deploy-backend.outputs.api_url }}
        run: |
          npm run build

          if [ ! -d "dist" ]; then
            echo "Error: dist directory not found after build"
            exit 1
          fi

      - name: Upload to S3
        run: |
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name purple-team-frontend-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`BucketName`].OutputValue' \
            --output text)

          if [ -z "$BUCKET_NAME" ]; then
            echo "Error: Could not retrieve bucket name from stack outputs"
            echo "Stack name: purple-team-frontend-prod"
            aws cloudformation describe-stacks --stack-name purple-team-frontend-prod
            exit 1
          fi

          echo "Uploading to bucket: $BUCKET_NAME"

          aws s3 sync frontend/dist s3://$BUCKET_NAME \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "index.html" \
            --exclude "*.txt"

          aws s3 cp frontend/dist/index.html s3://$BUCKET_NAME/index.html \
            --cache-control "public,max-age=0,must-revalidate"

      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name purple-team-frontend-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`DistributionId`].OutputValue' \
            --output text)

          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)

          echo "Waiting for invalidation $INVALIDATION_ID to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id $DISTRIBUTION_ID \
            --id $INVALIDATION_ID

      - name: Get production URL
        id: production-url
        run: |
          CLOUDFRONT_URL=$(aws cloudformation describe-stacks \
            --stack-name purple-team-frontend-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontUrl`].OutputValue' \
            --output text)

          echo "cloudfront_url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT

      - name: Add deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Production Deployed

          **Production URL:** ${{ steps.production-url.outputs.cloudfront_url }}

          **Backend Stack:** \`purple-team-backend-prod\`
          **Frontend Stack:** \`purple-team-frontend-prod\`

          **API URL:** \`${{ needs.deploy-backend.outputs.api_url }}\`

          **Deployed by:** ${{ github.actor }}
          **Commit:** ${{ github.sha }}
          EOF
